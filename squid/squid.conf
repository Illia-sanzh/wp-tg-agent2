# Squid Egress Proxy Configuration
# ─────────────────────────────────────────────────────────────────────────────
# OPEN INTERNET with SSRF protection.
#
# Any public domain is reachable. Private/internal IP ranges are blocked so
# the agent cannot reach other containers or host services (SSRF protection).
# Direct IP access is also blocked to force DNS-based hostname resolution.
#
# allowlist.txt is no longer enforced here but kept as a reference/fallback.
#
# We use plain HTTP CONNECT tunneling (no ssl_bump):
#   - HTTPS: client sends CONNECT host:443, Squid checks ACLs on the hostname.
#   - HTTP:  Squid checks ACLs on the destination domain.
# ─────────────────────────────────────────────────────────────────────────────

http_port 3128
visible_hostname openclaw-squid

# ── Logging ────────────────────────────────────────────────────────────────────
access_log /var/log/squid/access.log squid
cache_log /dev/null
logfile_rotate 7

# No content caching
cache deny all
cache_mem 8 MB
maximum_object_size 0 KB

# ── ACLs ──────────────────────────────────────────────────────────────────────

# Container subnets allowed to use this proxy
# 172.16.0.0/12 covers 172.16–172.31 (includes both agent-internal and proxy-external)
acl localnet src 172.16.0.0/12
acl localnet src 10.0.0.0/8
acl localnet src 127.0.0.1/32

# Only allow standard HTTP/HTTPS ports
acl Safe_ports port 80
acl Safe_ports port 443

# CONNECT method (used for HTTPS tunneling)
acl CONNECT method CONNECT
acl SSL_ports port 443

# ── SSRF protection: block private/internal destination IP ranges ──────────────
# dst matches on the resolved destination IP — catches hostnames that resolve
# to private addresses (DNS rebinding, internal service names, etc.)
acl private_dst dst 10.0.0.0/8
acl private_dst dst 172.16.0.0/12
acl private_dst dst 192.168.0.0/16
acl private_dst dst 127.0.0.0/8
acl private_dst dst 169.254.0.0/16
acl private_dst dst 100.64.0.0/10

# ── Access rules (order matters — first match wins) ────────────────────────────

# Block non-standard ports
http_access deny !Safe_ports

# Block CONNECT to non-SSL ports
http_access deny CONNECT !SSL_ports

# Deny requests not from our container network
http_access deny !localnet

# Block SSRF: deny access to private/internal IP ranges
# (private_dst uses resolved IP, so it also catches hostnames → private IPs)
http_access deny private_dst

# Allow everything else from our containers
http_access allow localnet

# Deny anything that somehow slipped through
http_access deny all

# ── Performance / Privacy ──────────────────────────────────────────────────────
forwarded_for off
