# Squid Egress Proxy Configuration
# ─────────────────────────────────────────────────────────────────────────────
# ALLOWLIST-ONLY: blocks everything except explicitly permitted domains.
#
# NOTE: We do NOT use ssl_bump (HTTPS content inspection).
# ssl_bump requires a CA certificate and https_port ssl-bump option.
# Without those, it crashes Squid on startup.
#
# We use plain HTTP CONNECT tunneling instead:
#   - HTTPS: client sends CONNECT host:443, Squid checks the destination
#     hostname against the allowlist, and either tunnels or denies it.
#   - HTTP:  Squid checks the destination domain against the allowlist.
#
# This is sufficient: we control WHICH domains are reachable, not the content.
# ─────────────────────────────────────────────────────────────────────────────

http_port 3128
visible_hostname openclaw-squid

# ── Logging ────────────────────────────────────────────────────────────────────
access_log /var/log/squid/access.log squid
cache_log /dev/null
logfile_rotate 7

# No content caching
cache deny all
cache_mem 8 MB
maximum_object_size 0 KB

# ── ACLs ──────────────────────────────────────────────────────────────────────

# Container subnets allowed to use this proxy
# 172.16.0.0/12 covers 172.16–172.31 (includes both agent-internal and proxy-external)
acl localnet src 172.16.0.0/12
acl localnet src 10.0.0.0/8
acl localnet src 127.0.0.1/32

# Only allow standard HTTP/HTTPS ports
acl Safe_ports port 80
acl Safe_ports port 443

# CONNECT method (used for HTTPS tunneling)
acl CONNECT method CONNECT
acl SSL_ports port 443

# Domain allowlist — loaded from mounted file
acl allowed_domains dstdomain "/etc/squid/allowlist.txt"

# ── Access rules ───────────────────────────────────────────────────────────────

# Block non-standard ports
http_access deny !Safe_ports

# Block CONNECT to non-SSL ports (no tunneling plain TCP on port 80)
http_access deny CONNECT !SSL_ports

# Deny requests not from our container network
http_access deny !localnet

# Allow only domains on the allowlist (covers both HTTP GET and CONNECT/HTTPS)
http_access allow localnet allowed_domains

# Deny everything else — this is the default anyway, but explicit is better
http_access deny all

# ── Performance / Privacy ──────────────────────────────────────────────────────
# max_filedesc was removed in Squid 6 — set via ulimit in the container instead
# workers 1 is the default; omitting it keeps single-process mode
dns_v4_first on

# Don't expose client IPs to destination servers
forwarded_for off
via off
